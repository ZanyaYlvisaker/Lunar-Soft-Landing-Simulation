# Lunar-Soft-Landing-Simulation 月球软着陆制导控制系统综合仿真

1 引言

1.1 研究背景

在月球探测带来巨大利益的驱使下，世界各国纷纷出台了自己的探月计划，再一次掀起了新一轮探月高潮。在月球上着陆分为两种，一种称为硬着陆，顾名思义，就是探测器在接近月球时不利用制动发动机减速而直接撞击月球。另一种 
称为软着陆，这种着陆方式要求探测器在距月面一定高度时开启制动系统，把探测器的速度抵消至零，然后利用小推力发动机把探测器对月速度控制在很小的范围内，从而使其在着陆时的速度具有几米每秒的数量级。显然，对于科学研究， 
对探测器实施月球软着陆的科学价值要大于硬着陆。

1.2 设计目标

1) 建立月球软着陆制导与控制系统仿真模型并进行仿真。 
2) 对相关参数对软着陆性能的影响进行分析，包括以下几个方面：
    
(1) 发动机推力偏差(±10%)对软着陆过程的影响； 

(2) 比冲偏差(±10%)对软着陆过程的影响； 

(3) 初始速度方向偏差对软着陆过程的影响； 

(4) 其它参数对软着陆过程的影响。


2 理论基础与模型建立

2.1 月球软着陆过程

本仿真实验以以下软着陆方法为基础：先经过一条绕月停泊轨道，然后再伺机制动下降到月球表面。探测器首先沿着飞月轨道飞向月球，在距月球表面一定高度时，动力系统给探测器施加一制动脉冲，使其进入一条绕月运行的停泊轨道；
然后根据事先选好的着陆点，选择霍曼变轨起始点，给探测器施加一制动脉冲，使其进入一条椭圆形的下降轨道，最后在近月点实施制动减速以实现软着陆。

2.2 坐标系定义

首先定义两个月球软着陆坐标系。第一个是月心惯性坐标系O1x1y1z1：原点O1选在月心，O1x1轴指向动力下降起始点，O1y1轴垂直于O1x1轴指向着陆点方向，O1z1轴按右手法则确定。
探测器在空间的位置可由表示成球坐标的形式，为从月心到探测器的距离，表示月球经度和纬度。
第二个就是探测器轨道坐标系oxyz：原点选在探测器质心，ox轴与从月心到探测器质心的矢径方向重合，背离月心方向为正，oy轴垂直于ox轴指向运动方向为正，oz按右手法则确定。

2.3 动力学模型

假设制动发动机为常推力液体发动机，忽略月球自转，则月球软着陆动力学方程可表示为：

r_dot2=Fu/m-miu(r/|r|^3)

其中：

r_dot2=r''+2omega×r'+w_dot×r+omega×(omega×r)

r是探测器月心距矢径， r'',r'分别表示径向加速度和速度，omega为轨道坐标系相对惯性系的角速度矢量，u为制动推力开关控制函数，miu为月球引力常数，m为探测器质量。用u、v、w表示上述动力学方程可得

r_dot=u

beta_dot=v/r

alpha_dot=w/(rsin(beta))

u_dot=Fcos(psi)/m-miu/r^2+(v^2+w^2)/r

v_dot=Fsin(psi)cos(phi)/m-uv/r+w^2/(rtan(beta))

w_dot=Fsin(psi)sin(phi)/m-uw/r-vw/(rtan(beta))

F_dot=-F/C

其中：F为推力发动机推力大小，psi、phi为轨道坐标系下推力矢量的方向角；C=Isp*gE，Isp为发动机比冲，gE为地表重力加速度常数。

2.4 制导律设计

本实验采用是一种基于多项式显式制导的燃耗次优控制制导律，该制导律由以下公式构成：

1）径向加速度计算公式

a=2k2=[6(rf-r-ut_go)-(uf-u)t_go]/t_go^2

2）控制变量（推力俯仰角、偏航角）计算公式

psi=arccos((a+miu/r^2-(v^2+w^2)/r)/aF)

phi=arccos((vf-v)/sqrt((wf-w)^2+(vf-v)^2))

3）剩余时间估计公式

t_go=sqrt((wf-w)^2+(vf-v)^2)/aH

其中，aF和aH可由加速度仪实时测得。分析上述公式可以看出，该制导律是剩余时间的函数，而剩余时间只与探测器当前状态和末端约束状态有关。


3 仿真系统设计与实现

3.1 仿真平台架构

本实验基于MATLAB环境设计了一个闭环仿真框架，主要包含以下模块：

1）动力学模型（6自由度）

2）制导律模块（多项式显式制导的燃耗次优控制）

3）控制器模块（推力方向控制）

4）偏差注入模块（推力、比冲、初始速度方向等）

5）分析记录模块（记录终端状态和过程数据并可视化结果）

具体步骤如下：

1）定义全局参数

2）建立动力学模型（ODE函数）：在球坐标系下，根据式(17-2)编写微分方程组。

3）制导律模块（函数形式）：输入当前状态、终端约束以及当前时间，输出推力方向角psi, phi，以及剩余时间t_go。

4）主仿真循环（使用ODE求解器）：使用ode45求解动力学微分方程组，但需要控制输入（制导律）在每一步更新。因此，采用“带有事件函数的循环”，即在每个积分步长调用制导律函数更新psi和phi。

5）偏差注入：完成标称工况下的仿真之后，使用带有偏差的值（推力、比冲、初始速度）分别再次进行仿真。

6）记录分析：在以上所有仿真结束后，提取过程以及终端状态，记录不同偏差条件下的结果，并绘制轨迹曲线、高度随时间变化、经纬度随时间变化、质量随时间变化等图，并对比分析不同工况下的结果。

3.2 核心模块实现

3.2.1 动力学模型模块

编写函数，输入状态变量、时间以及仿真参数，输出状态导数。

为了避免积分计算时出现奇点，需对输入的beta角进行处理使其不严格为0：

    if abs(beta) < 1e-5
        if beta == 0
            beta = 1e-5;
        else
            beta = sign(beta) * 1e-5;
        end
    end

每个积分步长调用制导律函数更新控制角psi和phi（制导律模块详见下一节）：

    [psi, phi, ~] = guidanceLaw(state, params);

根据式(2-3)编写微分方程：

    dr = u;
    dbeta = v / r;
    dalpha = w / (r * sin(beta));
    du = (F * cos(psi) / m) - params.mu_moon/r^2 + (v^2 + w^2)/r;
    dv = (F * sin(psi) * cos(phi) / m) - (u*v)/r + (w^2)/(r*tan(beta));
    dw = (F * sin(psi) * sin(phi) / m) - (u*w)/r - (v*w)/(r*tan(beta));
    dm = -F / C;

3.2.1 制导律计算模块

编写多项式显式制导律函数，输入状态变量和仿真参数，输出推力方向角psi, phi、剩余时间估计t_go。

首先根据状态量计算当前水平速度：

    delta_v = params.vf - v;
    delta_w = params.wf - w;
    V_horizontal = sqrt(delta_v^2 + delta_w^2); 

假设初始假设a_H = F/m，计算a_H：

    a_F = F / m;
    a_H_initial = a_F;

根据式(2-6)估计剩余时间：

    t_go_guess = V_horizontal / a_H_initial;

根据式(2-4)和式(2-5)迭代计算径向加速度和psi角，并确定剩余时间：

    max_iter = 10; % 最大迭代次数
    tolerance = 1e-5; % 收敛容差
    for iter = 1:max_iter
        % 计算径向加速度a
        numerator_a = 6*(params.rf - r - u*t_go_guess) - 2*(params.uf - u)*t_go_guess;
        a_radial = numerator_a / (t_go_guess^2);
        % 计算psi角
        term_gravity = params.mu_moon / r^2;
        term_centrifugal = (v^2 + w^2) / r;
        numerator_psi = a_radial + term_gravity - term_centrifugal;
        cos_psi = numerator_psi / a_F;
        cos_psi = max(min(cos_psi, 1), 0); % 限制在有效范围
        psi = acos(cos_psi);
        % 更新水平加速度和剩余时间
        a_H = a_F * sin(psi);
        t_go_new = V_horizontal / a_H;
        % 检查收敛
        if abs(t_go_new - t_go_guess) < tolerance
            % disp([iter, "收敛"])
        break;
        end
        t_go_guess = t_go_new;
    end
    t_go = t_go_guess;
    
根据式(2-5)计算phi角：
    
    Vc_x = params.vf - v; % 纬度方向速度增量
    Vc_y = params.wf - w; % 经度方向速度增量
    phi = acos(Vc_x/sqrt(Vc_x^2+Vc_y^2));

3.2.3 偏差注入模块

为了研究相关参数对软着陆性能的影响，在动力学模型和制导律函数中，实际使用的推力F和比冲Isp可能是标称值，也可能是带有偏差的值。因此可以在全局定义偏差因子，例如：

    thrust_factor = 1.1; % 推力增加10%
    Isp_factor = 0.9; % 比冲减少10%

然后在动力学模型和制导律函数中添加：

    F_actual = F_nominal * thrust_factor; % 推力变化
    Isp_actual = Isp_nominal * Isp_factor; % 比冲变化

对于初始速度方向偏差，在初始状态中原本v0=1692, w0=0，如果存在方向偏差，可以将初始速度矢量旋转一个角度（例如在水平面内旋转5度）：

    v = 1692 * cos(deviation_angle);
    w = 1692 * sin(deviation_angle);

并用相似的方式添加到动力学模型和制导律函数中。其中deviation_angle是初始速度方向偏差角（弧度）。

在初始运行时，需要对偏差因子进行初始化，以计算标称工况下的情况：

    if ~isfield(params, 'F_factor'), params.F_factor = 1.0; end
    if ~isfield(params, 'Isp_factor'), params.Isp_factor = 1.0; end
    if ~isfield(params, 'velocity_angle'), params.velocity_angle = 0; end

3.2.4 积分计算模块

在仿真运行程序中使用ode45积分器对动力学方程进行积分：

    odefun = @(t,y) lunarDynamics(t, y, params);
    [time, state] = ode45(odefun, params.tspan, initial_state, options);

其中，在options中设置终止条件：

    options = odeset('RelTol', params.reltol, 'AbsTol', params.abstol, 'Events', @(t,y) landingEvents(t,y,params.rf));

终止事件由终止事件函数定义：

    function [value, isterminal, direction] = landingEvents(~, y, rf)
    % 达到目标高度 (高度<2km)
    value = y(1) - rf; % 目标高度2km
    isterminal(1) = 1; % 触发时终止
    direction(1) = -1; % 下降穿过阈值时触发
    end

3.3 仿真参数设置

详见LunarSoftLandingSim.m

4 仿真结果与分析（本节图片见jpg文件夹）

4.1 标称工况分析

由仿真得出的结果绘制标准工况下的3D着陆轨迹（在直角坐标系中）如下图所示。

图4-1 标称工况下的3D着陆轨迹

图4-2、图4-3、图4-4分别是标准工况下探测器的高度、经纬度、质量随时间的变化曲线。可以看出，标准工况下的探测器软着陆仿真情况基本符合预期，降落过程耗时约539s，消耗燃料约275kg，燃料消耗与时间呈线性关系。这也验证了多项式显示制导方案的有效性。


图4-2 标称工况下的探测器高度变化


图4-3 标称工况下的探测器经纬度变化


图4-4 标称工况下的探测器质量变化


4.2 参数偏差影响分析

4.2.1 推力偏差影响(±10%)

图4-5 推力偏差对着陆时间和燃料消耗的影响

探测器发动机推力偏差（±10%）对着陆时间和燃料消耗的影响如图4-5，对探测器着陆位置（着陆过程中的经纬度）的影响如图4-6所示。

图4-6 推力偏差对探测器经纬度的影响

可以看出，发动机推力偏差对着陆时间影响显著，发动机推力增加10%会使着陆时间缩短约9.7%，推力减少10%会导致着陆时间延长约12.1%，而对燃料消耗影响不大；另外，发动机推力偏差也会影响探测器着陆轨迹纬度变化，推力偏差±10%对探测器终端纬度影响分别约为-12%和+10%，而对经度变化无影响，即终端位置与标况偏差约900m。

4.2.2 比冲偏差影响(±10%)

探测器发动机比冲偏差（±10%）对着陆时间和燃料消耗的影响如图4-7，对探测器着陆位置（着陆过程中的经纬度）的影响如图4-8所示。

图4-7 比冲偏差对着陆时间和燃料消耗的影响


图4-8 比冲偏差对探测器经纬度的影响

可以看出，发动机比冲偏差对着陆时间和燃料消耗均有影响，但对燃料消耗影响更明显。发动机比冲增加10%会使着陆时间延长约2.8%，但燃料消耗减少约6.6%；比冲减少10%会使着陆时间缩短约3.2%，而燃料消耗增加约7.5%。
发动机比冲偏差对探测器着陆轨迹经纬度影响与推力偏差类似，对经度无影响，但对纬度影响更小。比冲偏差±10%对探测器终端纬度影响分别约为+1.8%和-2.2%，即终端位置与标况偏差约150m。

4.2.3 初始速度方向偏差影响

探测器初始速度偏差（水平方向±5°、±3°）对着陆时间和燃料消耗的影响如图4-9，对探测器着陆位置（着陆过程中的经纬度）的影响如图4-10所示。

图4-9 初始速度偏差对着陆时间和燃料消耗的影响


图4-10 初始速度偏差对探测器经纬度的影响

可以看出，探测器初始速度方向偏差对着陆时间和燃料消耗无影响，对探测器纬度变化影响很小，但对经度影响较为明显。探测器初始水平速度偏差±3°时，探测器经度变化了±60%，终端位置偏差约1.6km；探测器初始水平速度偏差±5°时，探测器经度变化了±100%，终端位置偏差约2.7km。

5 结论与展望

5.1 主要结论

1. 制导律性能：标准工况下的探测器软着陆仿真情况基本符合预期，降落过程耗时约539s，消耗燃料约275kg，验证了多项式显示制导方案的有效性。

2. 参数敏感度：
   
（1）推力偏差对着陆时间影响显著，发动机推力增加10%会使着陆时间缩短约9.7%，推力减少10%会导致着陆时间延长约12.1%，；影响探测器着陆轨迹纬度变化，推力偏差±10%对探测器终端纬度影响约为10%，终端位置偏差约＜1km。

（2）比冲偏差对燃料消耗影响显著，发动机比冲增加10%会使燃料消耗减少约6.6%，比冲减少10%会使燃料消耗增加约7.5%。比冲偏差±10%对探测器终端纬度影响约为2%，终端位置偏差＜200m。

（3）初始速度方向偏差对经度影响显著，探测器初始水平速度偏差±3°时，探测器经度变化了±60%，终端位置偏差＞1km；探测器初始水平速度偏差±5°时，探测器经度变化了±100%，终端位置偏差＞2km。


5.2 不足与展望

（1）本仿真实验所使用的模型未考虑月球自传等复杂因素，具有一定的局限性，可在模型设计上考虑更多实际因素并提高模型经度；

（2）本仿真实验所使用的制导律对一些参数敏感，发动机推力和比冲的偏差会影响着陆时间和燃料消耗，初始速度偏差可能会导致着陆点大幅偏移，可以通过在制导律设计中引入偏差补偿项等方法提高制导律鲁棒性；

（3）本仿真实验所使用的制导律多项式近似模型忽略高阶项，导致末端轨迹精度下降，可以通过在加速度公式中增加终端收敛项，确保末端速度精确收敛至零，避免突变。
